# Vehicle Carbon Monoxide Monitor

## Project Overview
A vehicle carbon monoxide monitoring system using ESP8266 as the MCU/WiFi module, MQ7 analog sensor for CO detection, and IRLZ44N MOSFET for control. The system displays real-time readings on an OLED display and logs data to Supabase.

---

## Hardware Components
- **ESP8266** (NodeMCU 1.0 ESP-12E Module)
- **MQ7 Sensor** - Carbon Monoxide (CO) analog sensor
- **IRLZ44N MOSFET** - N-channel logic level MOSFET for switching
- **SSD1306 OLED Display** (128x64) - I2C interface
- **Miscellaneous** - Resistors, wiring, power supply

---

## Pin Configuration

| Component | Pin | Description |
|-----------|-----|-------------|
| MQ7 Sensor | GPIO 34 | Analog input for CO reading |
| MOSFET Gate | GPIO 26 | Digital output to control MOSFET |
| OLED Display | I2C (SDA/SCL) | Display interface |

---

## Arduino IDE Code

```cpp
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// ====== OLED SETUP ======
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// ====== PIN DEFINITIONS ======
#define MQ7_PIN 34        // Analog pin for MQ7 sensor
#define MOSFET_PIN 26     // Gate pin for IRLZ44N

// ====== WIFI CREDENTIALS ======
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

// ====== SUPABASE API CONFIGURATION ======
const char* SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co/rest/v1/your_table_name";
const char* SUPABASE_API_KEY = "YOUR_SUPABASE_API_KEY";
WiFiClient client; 

// ====== VARIABLES ======
float co_ppm = 0;
unsigned long lastSend = 0;
const unsigned long sendInterval = 15000;  // send every 15 seconds

void setup() {
  Serial.begin(115200);
  pinMode(MOSFET_PIN, OUTPUT);
  digitalWrite(MOSFET_PIN, LOW);
  
  // ====== OLED INIT ======
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println(F("SSD1306 allocation failed"));
    for (;;);
  }
  
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.println("Connecting WiFi...");
  display.display();
  
  // ====== WIFI CONNECT ======
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println("\nWiFi connected");
  display.clearDisplay();
  display.setCursor(0, 0);
  display.println("WiFi connected!");
  display.display();
  delay(1000);
}

void loop() {
  // Simulate CO sensor reading
  int analogValue = analogRead(MQ7_PIN);
  co_ppm = map(analogValue, 0, 4095, 0, 1000);  // simple mapping
  
  // ====== CONTROL MOSFET ======
  if (co_ppm > 200) {
    digitalWrite(MOSFET_PIN, HIGH);
  } else {
    digitalWrite(MOSFET_PIN, LOW);
  }
  
  // ====== DISPLAY DATA ======
  display.clearDisplay();
  display.setCursor(0, 0);
  display.print("CO Level: ");
  display.print(co_ppm);
  display.println(" ppm");
  display.print("MOSFET: ");
  display.println(digitalRead(MOSFET_PIN) ? "ON" : "OFF");
  display.display();
  
  // ====== SEND DATA TO SUPABASE ======
  if (millis() - lastSend > sendInterval) {
    sendToSupabase(co_ppm, digitalRead(MOSFET_PIN));
    lastSend = millis();
  }
  
  delay(1000);
}

void sendToSupabase(float co, int mosfetStatus) {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(client, SUPABASE_URL);
    http.addHeader("Content-Type", "application/json");
    http.addHeader("apikey", SUPABASE_API_KEY);
    http.addHeader("Authorization", String("Bearer ") + SUPABASE_API_KEY);
    
    String payload = "{\"co_ppm\":" + String(co) + ",\"mosfet_status\":" + String(mosfetStatus) + "}";
    
    int httpResponseCode = http.POST(payload);
    Serial.print("POST Response: ");
    Serial.println(httpResponseCode);
    
    if (httpResponseCode > 0) {
      Serial.println(http.getString());
    }
    
    http.end();
  } else {
    Serial.println("WiFi not connected!");
  }
}
```

---

## Required Libraries

Install these libraries in Arduino IDE via **Sketch → Include Library → Manage Libraries**:

1. **ESP8266 by ESP8266 Community**
2. **Adafruit SSD1306**
3. **Adafruit GFX Library**
4. **ArduinoJson** (optional but helpful for more structured payloads)

---

## System Operation

### How It Works

1. **Sensor Reading**: Reads CO levels from MQ7 analog input (GPIO 34)
2. **Display**: Shows current CO ppm and MOSFET state on the OLED display
3. **Threshold Control**: When CO > 200 ppm, activates MOSFET (can drive an alarm, LED, or ventilation system)
4. **Data Logging**: Every 15 seconds, posts readings to Supabase database via REST API
5. **WiFi Connectivity**: Maintains WiFi connection for cloud data logging

### Alarm Threshold
- **Normal Operation**: CO ≤ 200 ppm → MOSFET OFF
- **Alert Mode**: CO > 200 ppm → MOSFET ON (activates connected device)

---

## Supabase Database Setup

### Table Structure

Create a table named `sensor_data` (or your preferred name) with the following columns:

| Column Name | Data Type | Description |
|-------------|-----------|-------------|
| `id` | BIGINT | Primary key (auto-increment) |
| `created_at` | TIMESTAMP | Timestamp (default: now()) |
| `co_ppm` | FLOAT | Carbon monoxide reading in ppm |
| `mosfet_status` | INTEGER | MOSFET state (0=OFF, 1=ON) |

### Configuration Steps

1. Create a new Supabase project
2. Create the `sensor_data` table with the columns above
3. Get your Project URL and API key from Project Settings → API
4. Update the code with your credentials:
   - `SUPABASE_URL`
   - `SUPABASE_API_KEY`

---

## Arduino IDE Setup Guide

### Step 1: Install ESP8266 Board Support

1. **Open Arduino IDE**
2. **Go to**: File → Preferences
3. **Find**: "Additional Boards Manager URLs"
4. **Add this URL**:
   ```
   https://arduino.esp8266.com/stable/package_esp8266com_index.json
   ```
5. Click **OK**

### Step 2: Install Board Package

1. **Open Boards Manager**: Tools → Board → Boards Manager
2. **Search for**: `esp8266`
3. **Install**: "ESP8266 by ESP8266 Community" (latest stable version, e.g., 3.1.2 or newer)

### Step 3: Select Your Board

1. **Go to**: Tools → Board → esp8266 → **NodeMCU 1.0 (ESP-12E Module)**
2. **Select COM Port**: Tools → Port → **COMx** (your ESP8266 port)

### Step 4: Verify and Upload

1. Click **✔ Verify** to compile the code
2. Click **→ Upload** to flash the ESP8266

---

## Troubleshooting

### Board Not Found
- Ensure ESP8266 board support is installed via Boards Manager
- Check that the correct board is selected: NodeMCU 1.0 (ESP-12E Module)

### Upload Failed
- Verify the correct COM port is selected
- Install USB drivers for CH340/CP2102 if needed
- Press the FLASH button on the ESP8266 during upload (if required)

### WiFi Connection Issues
- Double-check SSID and password
- Ensure 2.4 GHz WiFi (ESP8266 doesn't support 5 GHz)
- Check signal strength

### Supabase Connection Fails
- Verify Supabase URL and API key
- Check internet connectivity
- Confirm table name and column names match the code
- Review Supabase table permissions (enable INSERT for anon/service role)

### OLED Not Working
- Verify I2C address (typically 0x3C or 0x3D)
- Check SDA/SCL connections
- Install Adafruit libraries correctly

---

## Safety Considerations

⚠️ **Important Safety Notes**:

1. **CO Detection**: This is a prototype system. For safety-critical applications, use certified CO detectors
2. **Calibration**: MQ7 sensors require proper calibration for accurate readings
3. **Sensor Warm-up**: MQ7 sensors need 24-48 hours of initial warm-up for stable readings
4. **Ventilation**: Always ensure proper ventilation in vehicles
5. **Power Supply**: Use appropriate power supply ratings for the ESP8266 and connected devices
6. **MOSFET Rating**: Ensure IRLZ44N can handle the load current of connected devices

---

## Future Enhancements

- Add SMS/email alerts for high CO levels
- Implement sensor calibration routine
- Add temperature and humidity compensation
- Create web dashboard for historical data visualization
- Implement battery backup system
- Add GPS location tracking
- Multi-sensor support for different vehicle zones

---

## License & Support

This is an educational/prototype project. Modify and use at your own discretion. For production use, consult with safety experts and obtain proper certifications.

---

**Last Updated**: November 2024  
**Platform**: ESP8266 (NodeMCU 1.0)  
**IDE**: Arduino IDE 1.8.x or 2.x