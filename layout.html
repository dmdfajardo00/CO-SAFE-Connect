<!DOCTYPE html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1976D2" />
  <title>CO‚ÄëSAFE Connect ‚Äî Vehicle CO Monitor</title>
  <meta name="description" content="Safety‚Äëcritical mobile web app for real‚Äëtime vehicle CO monitoring (PWA)." />
  
  <!-- Manifest (inlined + blob-registered) -->
  <link id="manifestLink" rel="manifest" href="#" />
  
  <style>
    /* --------- Design Tokens (CSS Custom Properties) --------- */
    :root{
      --blue: #1976D2;               /* Professional Blue */
      --green: #00C851;              /* Safety Green */
      --amber: #FF8800;              /* Warning Amber */
      --red: #FF3547;                /* Critical Red */
      --ink: #0b0f14;                /* Base text on light */
      --bg: #ffffff;                 /* App background */
      --card: #f6f8fb;               /* Card background */
      --muted: #6b7a90;              /* Secondary text */
      --border: #e3e8f0;             /* Hairlines */
      --focus: #5aa9ff;              /* Focus ring */
      --shadow: 0 4px 16px rgba(0,0,0,.08);

      --radius-xl: 20px;
      --radius-lg: 14px;
      --radius-md: 10px;

      --tap: 48px;                   /* Minimum touch target */
      --tap-lg: 56px;                /* Emergency */

      --safe: var(--green);
      --warn: var(--amber);
      --crit: var(--red);

      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial, system-ui, "Apple Color Emoji", "Segoe UI Emoji";
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0e1217;
        --card: #121923;
        --ink: #f2f5f8;
        --muted: #9db0c6;
        --border: #2a3442;
        --shadow: 0 6px 24px rgba(0,0,0,.4);
      }
    }

    /* High-contrast mode helper */
    @media (prefers-contrast: more){
      :root{ --focus: #ffffff; }
    }

    /* --------- Base --------- */
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink); font:16px/1.3 var(--font);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; flex-direction:column; min-height:100dvh;
    }
    *{box-sizing:border-box}
    :focus-visible{ outline: 3px solid var(--focus); outline-offset: 2px; border-radius: 8px; }

    .app{display:flex; flex-direction:column; height:100%;}

    /* Top app bar */
    .topbar{
      position:sticky; top:0; z-index:5; background:var(--bg);
      display:flex; align-items:center; gap:8px; padding:12px 16px; border-bottom:1px solid var(--border);
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand .logo{ width:28px; height:28px; border-radius:8px; background:linear-gradient(145deg,var(--blue),#42a5f5); box-shadow: var(--shadow); position:relative; }
    .brand .logo:after{ content:""; position:absolute; inset:6px; border-radius:6px; background:radial-gradient(circle at 30% 30%, #fff6, #0000); }
    .brand .title{ font-weight:700; letter-spacing:.2px; }
    .status-pill{ margin-left:auto; font-size:12px; padding:6px 10px; border-radius:999px; background:var(--card); border:1px solid var(--border); color:var(--muted); display:flex; align-items:center; gap:8px; }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--amber); box-shadow:0 0 0 3px #0000; }
    .dot.online{ background:var(--green); }
    .dot.offline{ background:var(--red); }

    /* Emergency banner */
    .banner{ position:sticky; top:56px; z-index:6; display:none; }
    .banner.active{ display:block; }
    .banner .card{
      margin:8px 12px; border-radius:16px; padding:12px; color:#fff; box-shadow: var(--shadow);
      display:flex; align-items:center; justify-content:space-between;
    }
    .banner.critical .card{ background:var(--red); }
    .banner.warning .card{ background:var(--amber); color:#1a1a1a; }
    .banner.safe .card{ background:var(--green); }
    .banner .msg{ font-weight:700; }
    .banner .actions{ display:flex; gap:8px; }
    .btn{ -webkit-tap-highlight-color: transparent; user-select:none; cursor:pointer; border:0; border-radius:12px; padding:12px 14px; font-weight:600; background:var(--blue); color:#fff; box-shadow: var(--shadow); }
    .btn.secondary{ background: #ffffff; color:#0f1720; }
    .btn.ghost{ background:transparent; color:#fff; box-shadow:none; border: 2px solid #fff; }
    .btn.block{ width:100%; }
    .btn.lg{ min-height: var(--tap-lg); font-size:18px; border-radius: 18px; }

    /* Content */
    main{ flex:1; overflow:auto; scroll-behavior:smooth; }
    section[role="tabpanel"]{ display:none; padding:12px; }
    section[role="tabpanel"].active{ display:block; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius-xl); padding:14px; box-shadow:var(--shadow); }

    /* Dashboard layout */
    .gauge-wrap{ display:grid; grid-template-columns:1fr; gap:12px; }
    .gauge-card{ display:flex; flex-direction:column; align-items:center; justify-content:center; padding:16px; }
    .gauge{ width:min(86vw,420px); height:min(86vw,420px); position:relative; }
    .gauge canvas{ width:100%; height:100%; }
    .gauge .readout{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:4px; }
    .ppm{ font-size: clamp(36px, 10vw, 56px); font-weight:800; letter-spacing:-.5px; }
    .label{ font-size:14px; color:var(--muted); }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .kv{ display:flex; flex-direction:column; gap:4px; }
    .kv .k{ font-size:12px; color:var(--muted); }
    .kv .v{ font-weight:700; }

    .sos{ margin-top:8px; }

    /* Alerts */
    .alert{ display:flex; align-items:flex-start; gap:10px; padding:12px; border-radius:12px; border:1px solid var(--border); background:var(--card); }
    .alert .badge{ width:10px; height:10px; border-radius:50%; margin-top:4px; }
    .alert .content{ flex:1; }
    .alert .title{ font-weight:700; }
    .alert .meta{ font-size:12px; color:var(--muted); }

    /* Analytics */
    .chart{ width:100%; aspect-ratio: 16/9; background:var(--card); border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:var(--shadow); position:relative; }
    .chart canvas{ width:100%; height:100%; }

    /* Device */
    .device-list{ display:flex; flex-direction:column; gap:10px; }

    /* Settings */
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .switch{ appearance:none; width:56px; height:32px; border-radius:999px; position:relative; background:#c7d1df; outline:none; transition:.2s; border:1px solid var(--border); }
    .switch:checked{ background:color-mix(in oklab, var(--blue) 60%, white); }
    .switch:before{ content:""; position:absolute; top:3px; left:3px; width:26px; height:26px; border-radius:50%; background:#fff; transition:.2s; box-shadow: var(--shadow); }
    .switch:checked:before{ left:27px; }

    input[type="range"]{ width:100%; }
    input, select{ font:inherit; padding:12px; border-radius:12px; border:1px solid var(--border); background:var(--bg); color:var(--ink); }

    /* Bottom nav */
    .tabbar{ position:sticky; bottom:0; background:var(--bg); border-top:1px solid var(--border); display:grid; grid-template-columns:repeat(4,1fr); }
    .tab{ -webkit-tap-highlight-color:transparent; height:64px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; color:var(--muted); font-size:12px; }
    .tab[aria-selected="true"]{ color:var(--blue); font-weight:700; }

    /* Skeletons */
    .skeleton{ position:relative; overflow:hidden; background:linear-gradient(90deg, #0000, #ffffff20, #0000), var(--card); border-radius:12px; height:14px; }

    /* Toast */
    .toast{ position:fixed; left:50%; bottom:88px; transform:translateX(-50%); background:var(--ink); color:var(--bg); padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); display:none; z-index:50; }
    .toast.show{ display:block; animation: fade 3s ease; }
    @keyframes fade{ 0%{opacity:0; transform:translate(-50%,8px);} 10%{opacity:1; transform:translate(-50%,0);} 90%{opacity:1;} 100%{opacity:0;} }

    /* Utilities */
    .row-split{ display:flex; gap:10px; }
    .row-split > *{ flex:1; }
  </style>
</head>
<body>
  <div class="app" aria-live="polite">
    <header class="topbar" role="banner">
      <div class="brand" aria-label="CO-SAFE brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">CO‚ÄëSAFE Connect</div>
      </div>
      <div class="status-pill" id="connectionPill" role="status" aria-live="polite">
        <span class="dot offline" id="connDot"></span>
        <span id="connText">Disconnected</span>
      </div>
    </header>

    <div id="emergencyBanner" class="banner" role="region" aria-label="Alert banner">
      <div class="card">
        <div class="msg" id="bannerMsg">CO levels normal</div>
        <div class="actions">
          <button class="btn ghost" id="btnMute" aria-pressed="false" title="Mute audible alert">Mute</button>
          <a class="btn secondary" id="btnCall" href="tel:911" role="button" aria-label="Call emergency contact">Call</a>
        </div>
      </div>
    </div>

    <main id="main" role="main">
      <!-- DASHBOARD -->
      <section id="tab-dashboard" role="tabpanel" aria-labelledby="nav-dashboard" class="active">
        <div class="gauge-wrap">
          <article class="card gauge-card" aria-label="CO level gauge">
            <div class="gauge" aria-live="polite">
              <canvas id="gaugeCanvas" width="480" height="480" aria-hidden="true"></canvas>
              <div class="readout">
                <div class="ppm" id="ppmReadout" aria-label="CO parts per million">-- ppm</div>
                <div class="label" id="statusReadout">Waiting for data‚Ä¶</div>
              </div>
            </div>
            <div class="grid" role="group" aria-label="Device status">
              <div class="kv">
                <div class="k">Device</div>
                <div class="v" id="deviceState">Not connected</div>
              </div>
              <div class="kv">
                <div class="k">Battery</div>
                <div class="v" id="batteryState">‚Äî</div>
              </div>
              <div class="kv">
                <div class="k">Filter health</div>
                <div class="v" id="filterHealth">‚Äî</div>
              </div>
              <div class="kv">
                <div class="k">Last update</div>
                <div class="v" id="lastUpdate">‚Äî</div>
              </div>
            </div>
            <div class="sos">
              <button class="btn lg block" id="sosBtn" aria-label="Send emergency alert">EMERGENCY SOS</button>
            </div>
          </article>

          <article class="card">
            <div class="row-split">
              <button class="btn" id="btnConnect" aria-controls="tab-device">Connect Device</button>
              <button class="btn" id="btnSimulate">Simulate Data</button>
            </div>
          </article>
        </div>
      </section>

      <!-- ALERTS -->
      <section id="tab-alerts" role="tabpanel" aria-labelledby="nav-alerts">
        <div class="card" id="alertsList" aria-live="polite" aria-relevant="additions text"> 
          <div class="skeleton" style="height:24px; margin-bottom:10px;"></div>
          <div class="skeleton" style="height:24px; width:60%;"></div>
        </div>
      </section>

      <!-- ANALYTICS -->
      <section id="tab-analytics" role="tabpanel" aria-labelledby="nav-analytics">
        <article class="chart" aria-label="CO history chart (24h)">
          <canvas id="chartCanvas" width="1200" height="675" aria-describedby="chartDesc"></canvas>
        </article>
        <p id="chartDesc" class="label">24‚Äëhour CO ppm trend. Pinch/drag to inspect; double‚Äëtap to reset.</p>
        <div class="row-split">
          <button class="btn" id="btnExport">Export JSON</button>
          <button class="btn" id="btnClear">Clear Data</button>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="tab-settings" role="tabpanel" aria-labelledby="nav-settings">
        <form id="settingsForm" class="card" autocomplete="off">
          <h3 style="margin:0 0 8px 0;">Alert thresholds</h3>
          <div class="field">
            <label for="warnThreshold">Warning threshold (ppm)</label>
            <input type="range" id="warnThreshold" min="10" max="50" step="1" value="25" aria-valuemin="10" aria-valuemax="50" aria-valuenow="25" />
            <div class="row" aria-live="polite"><span class="label">Current: <b id="warnVal">25</b> ppm</span></div>
          </div>
          <div class="field">
            <label for="critThreshold">Critical threshold (ppm)</label>
            <input type="range" id="critThreshold" min="30" max="100" step="1" value="50" />
            <div class="row"><span class="label">Current: <b id="critVal">50</b> ppm</span></div>
          </div>

          <div class="field">
            <div class="row">
              <input id="audible" class="switch" type="checkbox" role="switch" aria-checked="true" checked />
              <label for="audible">Audible alarms</label>
            </div>
          </div>

          <div class="field">
            <label for="contact">Emergency contact</label>
            <input id="contact" type="tel" inputmode="tel" placeholder="e.g., 0917 123 4567" aria-describedby="contactHelp" />
            <small id="contactHelp" class="label">Uses <code>tel:</code> dialing. Default is 911.</small>
          </div>

          <div class="field">
            <label for="units">Units</label>
            <select id="units" aria-label="Select units">
              <option value="ppm" selected>ppm</option>
            </select>
          </div>

          <div class="row-split">
            <button type="button" class="btn" id="btnSave">Save</button>
            <button type="reset" class="btn secondary" id="btnReset">Reset</button>
          </div>
        </form>

        <article class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 6px 0;">Device management</h3>
          <div class="device-list" id="deviceList" role="list">
            <!-- dynamically populated -->
          </div>
        </article>
      </section>
    </main>

    <!-- Bottom Tab Bar -->
    <nav class="tabbar" role="tablist" aria-label="Primary">
      <button class="tab" id="nav-dashboard" role="tab" aria-controls="tab-dashboard" aria-selected="true">üè†<span class="sr-only"> </span>Dashboard</button>
      <button class="tab" id="nav-alerts" role="tab" aria-controls="tab-alerts" aria-selected="false">‚ö†Ô∏è Alerts</button>
      <button class="tab" id="nav-analytics" role="tab" aria-controls="tab-analytics" aria-selected="false">üìà Analytics</button>
      <button class="tab" id="nav-settings" role="tab" aria-controls="tab-settings" aria-selected="false">‚öôÔ∏è Settings</button>
    </nav>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>
  </div>

  <audio id="beep" preload="auto">
    <source src="data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABsb2wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/wav" />
  </audio>

  <script>
  /* ============================================================
   * CO‚ÄëSAFE Connect (Single‚Äëfile PWA Prototype)
   * - Real‚Äëtime gauge + alerts
   * - Offline-first shell with Service Worker
   * - Accessibility & safety‚Äëfirst UI
   * ============================================================ */

  // ---------- Utilities ----------
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const fmt = (v) => `${v.toFixed(0)} ppm`;

  const store = {
    get k(){ return 'cosafe:v1'; },
    load(){ try{ return JSON.parse(localStorage.getItem(this.k)) || {}; }catch{ return {}; } },
    save(data){ localStorage.setItem(this.k, JSON.stringify(data)); }
  };

  const state = Object.assign({
    connected: false,
    battery: null,
    filterHealth: 100,
    lastUpdate: null,
    audible: true,
    thresholds: { warn: 25, crit: 50 },
    history: [], // {t, v}
    alerts: [],
    contact: '911',
    muted: false,
    simulating: false
  }, store.load());

  // ---------- Manifest (Blob link so we remain single-file) ----------
  (function makeManifest(){
    const manifest = {
      name: "CO‚ÄëSAFE Connect",
      short_name: "CO‚ÄëSAFE",
      description: "Vehicle CO monitoring (safety‚Äëcritical).",
      start_url: ".",
      display: "standalone",
      background_color: getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || "#ffffff",
      theme_color: "#1976D2",
      icons: [
        { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect rx='24' ry='24' width='128' height='128' fill='%231976D2'/%3E%3Ccircle cx='64' cy='64' r='26' fill='%23fff'/%3E%3Ctext x='64' y='72' text-anchor='middle' font-family='Arial' font-size='40' fill='%231976D2'%3ECO%3C/text%3E%3C/svg%3E", sizes: "128x128", type: "image/svg+xml" }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
    const url = URL.createObjectURL(blob);
    const link = document.getElementById('manifestLink');
    link.setAttribute('href', url);
  })();

  // ---------- Service Worker (constructed at runtime) ----------
  async function registerSW(){
    if(!('serviceWorker' in navigator)) return;
    try{
      const swCode = `
        const CACHE = 'cosafe-v1';
        const CORE = ['.'];
        self.addEventListener('install', e => {
          e.waitUntil(caches.open(CACHE).then(c => c.addAll(CORE)).then(() => self.skipWaiting()));
        });
        self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', e => {
          const req = e.request;
          if(req.method !== 'GET') return;
          e.respondWith(
            caches.match(req).then(cached => cached || fetch(req).then(res => {
              const copy = res.clone();
              caches.open(CACHE).then(c => c.put(req, copy));
              return res;
            }).catch(() => caches.match('.')))
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const swURL = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(swURL);
    }catch(err){ console.warn('SW registration failed', err); }
  }
  registerSW();

  // ---------- DOM Refs ----------
  const gaugeCanvas = document.getElementById('gaugeCanvas');
  const chartCanvas = document.getElementById('chartCanvas');
  const ppmReadout = document.getElementById('ppmReadout');
  const statusReadout = document.getElementById('statusReadout');
  const connDot = document.getElementById('connDot');
  const connText = document.getElementById('connText');
  const deviceState = document.getElementById('deviceState');
  const batteryState = document.getElementById('batteryState');
  const filterHealth = document.getElementById('filterHealth');
  const lastUpdate = document.getElementById('lastUpdate');
  const banner = document.getElementById('emergencyBanner');
  const bannerMsg = document.getElementById('bannerMsg');
  const btnMute = document.getElementById('btnMute');
  const btnCall = document.getElementById('btnCall');
  const sosBtn = document.getElementById('sosBtn');
  const alertsList = document.getElementById('alertsList');
  const deviceList = document.getElementById('deviceList');
  const toast = document.getElementById('toast');

  const btnConnect = document.getElementById('btnConnect');
  const btnSimulate = document.getElementById('btnSimulate');
  const btnExport = document.getElementById('btnExport');
  const btnClear = document.getElementById('btnClear');

  const warnThreshold = document.getElementById('warnThreshold');
  const critThreshold = document.getElementById('critThreshold');
  const warnVal = document.getElementById('warnVal');
  const critVal = document.getElementById('critVal');
  const audible = document.getElementById('audible');
  const contact = document.getElementById('contact');
  const btnSave = document.getElementById('btnSave');
  const btnReset = document.getElementById('btnReset');

  // ---------- Tabs ----------
  const tabs = ['dashboard','alerts','analytics','settings'];
  tabs.forEach(name => {
    const btn = document.getElementById(`nav-${name}`);
    btn.addEventListener('click', () => setTab(name));
  });
  function setTab(name){
    tabs.forEach(n => {
      document.getElementById(`nav-${n}`).setAttribute('aria-selected', String(n===name));
      const pnl = document.getElementById(`tab-${n}`);
      pnl.classList.toggle('active', n===name);
      pnl.setAttribute('tabindex', n===name? '0':'-1');
      if(n===name) pnl.focus({preventScroll:true});
    });
  }

  // ---------- Gauge Drawing ----------
  const gctx = gaugeCanvas.getContext('2d');
  function drawGauge(val){
    const w = gaugeCanvas.width, h = gaugeCanvas.height; gctx.clearRect(0,0,w,h);
    const cx = w/2, cy = h/2, r = Math.min(w,h)/2 - 24;
    const start = Math.PI*0.75, end = Math.PI*2.25; // 270¬∞ span

    // background arc
    gctx.lineCap = 'round';
    gctx.lineWidth = 28; gctx.strokeStyle = '#e5eaf1';
    if (matchMedia('(prefers-color-scheme: dark)').matches) gctx.strokeStyle = '#1e2836';
    gctx.beginPath(); gctx.arc(cx,cy,r,start,end); gctx.stroke();

    // colored ranges
    const warn = state.thresholds.warn, crit = state.thresholds.crit;
    const norm = x => start + (x/100) * (end-start);
    const segs = [
      {from:0,to:warn,color:getComputedStyle(document.documentElement).getPropertyValue('--green').trim()},
      {from:warn,to:crit,color:getComputedStyle(document.documentElement).getPropertyValue('--amber').trim()},
      {from:crit,to:100,color:getComputedStyle(document.documentElement).getPropertyValue('--red').trim()},
    ];
    segs.forEach(s => { gctx.strokeStyle = s.color; gctx.beginPath(); gctx.arc(cx,cy,r, norm(s.from), norm(s.to)); gctx.stroke(); });

    // value arc
    const vAng = norm(clamp(val,0,100));
    gctx.strokeStyle = getColorFor(val);
    gctx.beginPath(); gctx.arc(cx,cy,r, start, vAng); gctx.stroke();

    // needle
    gctx.save();
    gctx.translate(cx,cy); gctx.rotate(vAng - Math.PI/2);
    gctx.fillStyle = gctx.strokeStyle;
    gctx.beginPath(); gctx.moveTo(-8,0); gctx.lineTo(0,-r+8); gctx.lineTo(8,0); gctx.closePath(); gctx.fill();
    gctx.restore();

    // center cap
    gctx.fillStyle = '#fff'; if (matchMedia('(prefers-color-scheme: dark)').matches) gctx.fillStyle = '#0f1520';
    gctx.beginPath(); gctx.arc(cx,cy,10,0,Math.PI*2); gctx.fill();
  }

  function getColorFor(v){
    if(v >= state.thresholds.crit) return getVar('--red');
    if(v >= state.thresholds.warn) return getVar('--amber');
    return getVar('--green');
  }
  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  // ---------- Chart ----------
  const cctx = chartCanvas.getContext('2d');
  let chartView = {x0:0,x1:1}; // normalized viewport
  function drawChart(){
    const w = chartCanvas.width, h = chartCanvas.height;
    cctx.clearRect(0,0,w,h);
    // axes
    cctx.strokeStyle = matchMedia('(prefers-color-scheme: dark)').matches ? '#2a3442' : '#e3e8f0';
    cctx.lineWidth = 2; cctx.beginPath(); cctx.moveTo(50, h-40); cctx.lineTo(w-10, h-40); cctx.moveTo(50, 20); cctx.lineTo(50, h-40); cctx.stroke();

    const data = state.history;
    if(data.length < 2) return;
    const t0 = data[0].t, t1 = data[data.length-1].t;
    const vx0 = t0 + (t1-t0)*chartView.x0; const vx1 = t0 + (t1-t0)*chartView.x1;
    const view = data.filter(d => d.t>=vx0 && d.t<=vx1);
    const min = 0; const max = Math.max(100, ...view.map(d=>d.v));

    const sx = x => 50 + ( (x - vx0) / (vx1 - vx0) ) * (w-60);
    const sy = y => (h-40) - ( (y-min) / (max-min) ) * (h-60);

    // grid
    cctx.strokeStyle = cctx.strokeStyle + '55'; cctx.lineWidth = 1;
    for(let i=0;i<=5;i++){ const yy = (h-40) - i*(h-60)/5; cctx.beginPath(); cctx.moveTo(50,yy); cctx.lineTo(w-10,yy); cctx.stroke(); }

    // path
    cctx.beginPath(); cctx.lineWidth = 3; cctx.strokeStyle = getVar('--blue');
    view.forEach((d,i)=>{ const x = sx(d.t), y = sy(d.v); if(i===0) cctx.moveTo(x,y); else cctx.lineTo(x,y); });
    cctx.stroke();

    // thresholds
    cctx.setLineDash([6,6]); cctx.strokeStyle = getVar('--amber'); cctx.beginPath(); cctx.moveTo(50, sy(state.thresholds.warn)); cctx.lineTo(w-10, sy(state.thresholds.warn)); cctx.stroke();
    cctx.strokeStyle = getVar('--red'); cctx.beginPath(); cctx.moveTo(50, sy(state.thresholds.crit)); cctx.lineTo(w-10, sy(state.thresholds.crit)); cctx.stroke();
    cctx.setLineDash([]);
  }

  // pinch/drag to zoom/pan
  (function chartGestures(){
    let dragging = false, lastX = 0; let touch0 = null;
    chartCanvas.addEventListener('pointerdown', e=>{ dragging=true; lastX=e.clientX; chartCanvas.setPointerCapture(e.pointerId); });
    chartCanvas.addEventListener('pointermove', e=>{
      if(!dragging) return; const dx = (e.clientX-lastX)/chartCanvas.clientWidth; lastX=e.clientX; chartView.x0 = clamp(chartView.x0-dx,0,.99); chartView.x1 = clamp(chartView.x1-dx,.01,1); drawChart();
    });
    chartCanvas.addEventListener('pointerup', ()=>{ dragging=false; });
    chartCanvas.addEventListener('dblclick', ()=>{ chartView={x0:0,x1:1}; drawChart(); });

    chartCanvas.addEventListener('touchstart', e=>{ if(e.touches.length===2){ touch0 = [...e.touches].map(t=>t.clientX); } });
    chartCanvas.addEventListener('touchmove', e=>{ if(e.touches.length===2 && touch0){ const xs=[...e.touches].map(t=>t.clientX); const span0=Math.abs(touch0[0]-touch0[1]); const span1=Math.abs(xs[0]-xs[1]); const k= span0? (span1/span0):1; const mid=(chartView.x0+chartView.x1)/2; const range=(chartView.x1-chartView.x0)/k; chartView.x0=clamp(mid-range/2,0,.99); chartView.x1=clamp(mid+range/2,.01,1); touch0=xs; drawChart(); } });
    chartCanvas.addEventListener('touchend', ()=>{ touch0=null; });
  })();

  // ---------- Alerts ----------
  function addAlert(level, title, meta){
    const el = document.createElement('div'); el.className='alert';
    const color = level==='critical'? getVar('--red') : level==='warning'? getVar('--amber') : level==='info'? getVar('--blue') : getVar('--green');
    el.innerHTML = `<div class="badge" style="background:${color}"></div>
      <div class="content">
        <div class="title">${title}</div>
        <div class="meta">${new Date().toLocaleString()} ‚Ä¢ ${meta||''}</div>
      </div>`;
    alertsList.prepend(el);
    state.alerts.unshift({t:Date.now(), level, title, meta});
    persist();
  }

  // ---------- History ----------
  function pushSample(v){
    const t = Date.now();
    state.history.push({t, v});
    if(state.history.length>5000) state.history.shift();
    persist();
  }

  function persist(){ store.save(state); }

  // ---------- Status + Banner ----------
  function setConnection(connected){
    state.connected = connected; connDot.classList.toggle('online', connected); connDot.classList.toggle('offline', !connected);
    connText.textContent = connected? 'Connected' : 'Disconnected';
    deviceState.textContent = connected? 'Online' : 'Not connected';
  }

  function updateBanner(v){
    banner.classList.remove('active','safe','warning','critical');
    if(v >= state.thresholds.crit){
      banner.classList.add('active','critical');
      bannerMsg.textContent = 'CRITICAL: CO dangerously high! Ventilate immediately.';
    } else if(v >= state.thresholds.warn){
      banner.classList.add('active','warning');
      bannerMsg.textContent = 'Warning: Elevated CO detected. Check exhaust & ventilation.';
    } else if(state.simulating){
      banner.classList.add('active','safe');
      bannerMsg.textContent = 'Levels within safe range.';
    }
  }

  function toastMsg(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2800); }

  // ---------- Audio ----------
  const beep = document.getElementById('beep');
  function alarm(){ if(state.audible && !state.muted){ beep.currentTime=0; beep.play().catch(()=>{}); } }

  // ---------- Simulated data stream ----------
  let simTimer = null; let v=0;
  function startSim(){
    if(simTimer) return; state.simulating = true; toastMsg('Simulation started');
    v = 10 + Math.random()*10; // starting baseline
    simTimer = setInterval(()=>{
      // simple stochastic process + occasional spikes
      const spike = Math.random()<0.04 ? (20+Math.random()*50) : 0;
      const drift = (Math.random()-.5)*3; v = clamp(v + drift + spike, 0, 100);
      ingestValue(v);
    }, 1500);
  }
  function stopSim(){ if(simTimer){ clearInterval(simTimer); simTimer=null; state.simulating=false; toastMsg('Simulation stopped'); } }

  // ---------- Ingest & UI update ----------
  function ingestValue(val){
    pushSample(val);
    ppmReadout.textContent = fmt(val);
    statusReadout.textContent = val>=state.thresholds.crit? 'CRITICAL' : val>=state.thresholds.warn? 'ELEVATED' : 'SAFE';
    statusReadout.style.color = getColorFor(val);
    drawGauge(val);
    drawChart();
    lastUpdate.textContent = new Date().toLocaleTimeString();
    filterHealth.textContent = Math.max(0, Math.round(state.filterHealth - Math.random()*0.2)) + '%';
    if(val>=state.thresholds.crit){ alarm(); addAlert('critical', 'Critical CO level', `${fmt(val)} exceeded critical threshold`); }
    else if(val>=state.thresholds.warn){ addAlert('warning', 'Elevated CO level', `${fmt(val)} exceeded warning threshold`); }
    updateBanner(val);
  }

  // ---------- Device mock / Bluetooth placeholder ----------
  btnConnect.addEventListener('click', async () => {
    // If Web Bluetooth is available, we could request device here.
    // For prototype, simulate a successful connection.
    setConnection(true); batteryState.textContent = (80 + Math.random()*20).toFixed(0)+'%';
    addDeviceCard('CO‚ÄëSAFE Sensor A1', 'Online', batteryState.textContent);
    toastMsg('Device connected');
  });

  function addDeviceCard(name, status, battery){
    const c = document.createElement('div'); c.className='alert';
    c.innerHTML = `<div class="badge" style="background:${getVar('--green')}"></div>
      <div class="content">
        <div class="title">${name}</div>
        <div class="meta">${status} ‚Ä¢ Battery ${battery}</div>
      </div>
      <div>
        <button class="btn" style="min-width:84px" aria-label="Calibrate ${name}">Calibrate</button>
      </div>`;
    deviceList.prepend(c);
  }

  // ---------- Buttons ----------
  btnSimulate.addEventListener('click', ()=>{ simTimer? stopSim() : startSim(); btnSimulate.textContent = simTimer? 'Stop' : 'Simulate Data'; });
  btnExport.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify({history:state.history, alerts:state.alerts}, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = `cosafe-data-${new Date().toISOString().slice(0,19)}.json`; a.click(); URL.revokeObjectURL(url);
  });
  btnClear.addEventListener('click', ()=>{ state.history=[]; drawChart(); toastMsg('History cleared'); persist(); });

  sosBtn.addEventListener('click', ()=>{ addAlert('emergency','SOS triggered','User pressed emergency'); alarm(); const tel = (state.contact||'911').replace(/\s+/g,''); location.href = `tel:${tel}`; });
  btnMute.addEventListener('click', ()=>{ state.muted = !state.muted; btnMute.setAttribute('aria-pressed', String(state.muted)); btnMute.textContent = state.muted? 'Unmute' : 'Mute'; });

  // ---------- Settings sync ----------
  function syncSettingsUI(){
    warnThreshold.value = state.thresholds.warn; critThreshold.value = state.thresholds.crit;
    warnVal.textContent = state.thresholds.warn; critVal.textContent = state.thresholds.crit;
    audible.checked = !!state.audible; contact.value = state.contact || '';
  }
  warnThreshold.addEventListener('input', ()=>{ warnVal.textContent = warnThreshold.value; drawGauge(state.history.at(-1)?.v||0); drawChart(); });
  critThreshold.addEventListener('input', ()=>{ critVal.textContent = critThreshold.value; drawGauge(state.history.at(-1)?.v||0); drawChart(); });
  btnSave.addEventListener('click', ()=>{
    state.thresholds.warn = Number(warnThreshold.value); state.thresholds.crit = Number(critThreshold.value);
    state.audible = audible.checked; state.contact = contact.value || '911';
    btnCall.href = `tel:${(state.contact||'911').replace(/\s+/g,'')}`;
    persist(); toastMsg('Settings saved');
  });
  btnReset.addEventListener('click', ()=>{ Object.assign(state.thresholds,{warn:25,crit:50}); state.audible=true; state.contact='911'; syncSettingsUI(); drawGauge(state.history.at(-1)?.v||0); drawChart(); toastMsg('Settings reset'); });

  // ---------- Boot ----------
  function boot(){
    setConnection(state.connected); batteryState.textContent = state.battery? state.battery+'%' : '‚Äî'; filterHealth.textContent = state.filterHealth+'%';
    btnCall.href = `tel:${(state.contact||'911').replace(/\s+/g,'')}`;
    syncSettingsUI();

    // Initial skeleton removal
    alertsList.innerHTML = '';
    if(state.alerts?.length){ state.alerts.slice(0,20).forEach(a=> addAlert(a.level, a.title, a.meta)); }

    // Prime some demo data if none
    if(!state.history?.length){
      const now = Date.now();
      for(let i=0;i<120;i++){ state.history.push({t: now - (120-i)*60*1000, v: Math.max(0, 10 + Math.sin(i/8)*6 + (Math.random()*3))}); }
    }

    const last = state.history.at(-1).v; ppmReadout.textContent = fmt(last); statusReadout.textContent = last>=state.thresholds.crit? 'CRITICAL' : last>=state.thresholds.warn? 'ELEVATED' : 'SAFE';
    drawGauge(last); drawChart(); updateBanner(last);
  }
  boot();

  // Expose for quick testing in console
  window.coSafe = { ingestValue, startSim, stopSim, state };
  </script>
</body>
</html>
